# Laravel æ€§èƒ½ä¼˜åŒ–è®°å½•

## é—®é¢˜æè¿°
ç½‘ç«™å‡ºç°ä¸¥é‡çš„å†…å­˜æº¢å‡ºé—®é¢˜ï¼Œé”™è¯¯ä¿¡æ¯ï¼š
```
Allowed memory size of 268435456 bytes exhausted (tried to allocate 528384 bytes) 
at HasRelationships.php:671
```

## æ ¹æœ¬åŸå› 
å¤§é‡ä½¿ç”¨ Eloquent çš„ `with()` æ–¹æ³•è¿›è¡Œå…³ç³»æŸ¥è¯¢ï¼Œå¯¼è‡´å†…å­˜æ¶ˆè€—è¿‡å¤§ã€‚

## ä¼˜åŒ–ç­–ç•¥
å°†æ‰€æœ‰ Eloquent å…³ç³»æŸ¥è¯¢æ›¿æ¢ä¸ºåŸç”Ÿ DB æŸ¥è¯¢ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨ã€‚

## å·²ä¼˜åŒ–çš„æ§åˆ¶å™¨

### 1. DashboardController
- æ›¿æ¢å¤æ‚çš„ Eloquent æŸ¥è¯¢ä¸ºè½»é‡çº§ DB æŸ¥è¯¢
- æ·»åŠ è¡¨å­˜åœ¨æ£€æŸ¥å’Œé”™è¯¯å¤„ç†
- ä¼˜åŒ–ç»Ÿè®¡æ•°æ®è®¡ç®—

### 2. CategoryController
- ç®€åŒ–åˆ†ç±»æŸ¥è¯¢é€»è¾‘
- ç§»é™¤å¤æ‚çš„ç»Ÿè®¡è®¡ç®—
- ä½¿ç”¨ DB æŸ¥è¯¢æ›¿ä»£ Eloquent å…³ç³»
- **é‡è¦å‘ç°**ï¼šè§†å›¾ä¸­å¯¹åˆ†é¡µå¯¹è±¡çš„ä¸å½“æ“ä½œä¼šå¯¼è‡´å†…å­˜é—®é¢˜
  - é¿å… `$categories->count()` å’Œ `$categories->where()->count()`
  - é¿å…å¯¹åˆ†é¡µå¯¹è±¡è¿›è¡Œ `foreach` å¾ªç¯
  - ä¸ºæ¨¡æ€æ¡†æä¾›å•ç‹¬çš„æ•°æ®é›†åˆ

### 3. InventoryAlertController
- ä¼˜åŒ–ä»·æ ¼ç³»åˆ—æŸ¥è¯¢
- ç®€åŒ–åº“å­˜æŸ¥è¯¢é€»è¾‘

### 4. InventoryCheckController
- ä¼˜åŒ–ç›˜ç‚¹è®°å½•æŸ¥è¯¢
- æ›¿æ¢å…³ç³»æŸ¥è¯¢ä¸º JOIN æŸ¥è¯¢

### 5. Api/ChartDataController
- ä¼˜åŒ–å›¾è¡¨æ•°æ®æŸ¥è¯¢
- ä½¿ç”¨ LEFT JOIN å’Œ GROUP BY æ›¿ä»£å…³ç³»æŸ¥è¯¢

### 6. ReturnController
- ä¼˜åŒ–é€€è´§è®°å½•åˆ—è¡¨æŸ¥è¯¢
- åˆ†ç¦»è¯¦æƒ…æ•°æ®è·å–
- ä½¿ç”¨åˆ†é¡µå’Œ JOIN æŸ¥è¯¢

### 7. UserController
- ä¼˜åŒ–ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢
- åˆ†ç¦»ç”¨æˆ·-ä»“åº“å…³ç³»æŸ¥è¯¢

### 8. StockOutController
- ä¼˜åŒ–å‡ºåº“è®°å½•æŸ¥è¯¢
- åˆ†ç¦»å‡ºåº“è¯¦æƒ…æ•°æ®

### 9. StockInController
- ä¼˜åŒ–å…¥åº“è®°å½•æŸ¥è¯¢
- åˆ†ç¦»å…¥åº“è¯¦æƒ…æ•°æ®

### 10. SaleController
- ä¼˜åŒ–é”€å”®è®°å½•æŸ¥è¯¢
- åˆ†ç¦»é”€å”®è¯¦æƒ…å’Œç›²è¢‹å‘è´§æ•°æ®

### 11. InventoryController
- ä¼˜åŒ–åº“å­˜åˆ—è¡¨æŸ¥è¯¢
- åˆ†ç¦»åº“å­˜è®°å½•æ•°æ®

### 12. InventoryTurnoverController
- ä¼˜åŒ–åº“å­˜å‘¨è½¬ç‡è®¡ç®—
- ç®€åŒ–é¢„è­¦å•†å“æŸ¥è¯¢

### 13. Mobile/DashboardController
- ä¼˜åŒ–ç§»åŠ¨ç«¯ä»ªè¡¨æ¿æŸ¥è¯¢
- åˆ†ç¦»å…¥åº“è®°å½•è¯¦æƒ…è·å–

### 14. Mobile/SaleController
- ä¼˜åŒ–ç§»åŠ¨ç«¯é”€å”®è®°å½•æŸ¥è¯¢
- åˆ†ç¦»é”€å”®è¯¦æƒ…å’Œç›²è¢‹æ•°æ®

### 15. routes/api.php
- ä¼˜åŒ– API è·¯ç”±ä¸­çš„åº“å­˜æŸ¥è¯¢

## æŠ€æœ¯ç»†èŠ‚

### ä¼˜åŒ–å‰ï¼ˆé—®é¢˜ä»£ç ï¼‰
```php
$records = ReturnRecord::with(['user', 'store', 'returnDetails.product'])->get();
```

### ä¼˜åŒ–åï¼ˆè§£å†³æ–¹æ¡ˆï¼‰
```php
$records = DB::table('return_records')
    ->leftJoin('users', 'return_records.user_id', '=', 'users.id')
    ->leftJoin('stores', 'return_records.store_id', '=', 'stores.id')
    ->select('return_records.*', 'users.real_name as user_name', 'stores.name as store_name')
    ->get();
```

### è§†å›¾ä¸­çš„å¸¸è§é—®é¢˜
```php
// é—®é¢˜ä»£ç  - ä¼šå¯¼è‡´å†…å­˜æº¢å‡º
{{ $categories->count() }}
{{ $categories->where('is_active', true)->count() }}

@foreach($categories as $category)
    // å¯¹åˆ†é¡µå¯¹è±¡å¾ªç¯
@endforeach
```

```php
// è§£å†³æ–¹æ¡ˆ - åœ¨æ§åˆ¶å™¨ä¸­å•ç‹¬è·å–æ•°æ®
$totalCategories = DB::table('categories')->count();
$activeCategories = DB::table('categories')->where('is_active', true)->count();
$allCategories = DB::table('categories')->get(); // ä¸ºå¾ªç¯æä¾›å•ç‹¬æ•°æ®
```

## ä¼˜åŒ–æ•ˆæœ
- å¤§å¹…å‡å°‘å†…å­˜ä½¿ç”¨
- é¿å… Eloquent å…³ç³»æŸ¥è¯¢çš„å†…å­˜å¼€é”€
- æé«˜æŸ¥è¯¢æ€§èƒ½
- ä¿æŒä»£ç åŠŸèƒ½å®Œæ•´æ€§

## è°ƒè¯•ç»éªŒæ•™è®­

### æµè§ˆå™¨ç¼“å­˜é—®é¢˜
åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­å‘ç°ï¼Œæœ‰æ—¶å€™ä»£ç å·²ç»ä¿®å¤ï¼Œä½†æµè§ˆå™¨ä»ç„¶æ˜¾ç¤ºé”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºï¼š
1. æµè§ˆå™¨ç¼“å­˜äº†å‡ºé”™çš„é¡µé¢
2. æµè§ˆå™¨ç¼“å­˜äº†æœ‰é—®é¢˜çš„ JavaScript æ–‡ä»¶
3. æµè§ˆå™¨ç¼“å­˜äº† CSS æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- ä½¿ç”¨éšç§æ¨¡å¼/æ— ç—•æ¨¡å¼æµ‹è¯•
- ä½¿ç”¨ä¸åŒçš„æµè§ˆå™¨æµ‹è¯•
- å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+F5ï¼‰

### è°ƒè¯•æŠ€å·§
1. é€æ­¥ç®€åŒ–ä»£ç ï¼Œä»æœ€ç®€å•çš„æƒ…å†µå¼€å§‹æµ‹è¯•
2. ä½¿ç”¨æ—¥å¿—è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ
3. åˆ†ç¦»æ•°æ®åº“æŸ¥è¯¢å’Œè§†å›¾æ¸²æŸ“ï¼Œç¡®å®šé—®é¢˜æ‰€åœ¨
4. æ£€æŸ¥è§†å›¾æ–‡ä»¶ä¸­å¯¹æ•°æ®çš„æ“ä½œï¼Œç‰¹åˆ«æ˜¯åˆ†é¡µå¯¹è±¡
5. å§‹ç»ˆè€ƒè™‘æµè§ˆå™¨ç¼“å­˜çš„å½±å“

## æ³¨æ„äº‹é¡¹
1. æ‰€æœ‰ä¼˜åŒ–éƒ½ä¿æŒäº†åŸæœ‰çš„åŠŸèƒ½å’Œæ•°æ®ç»“æ„
2. è§†å›¾å…¼å®¹æ€§é€šè¿‡æ•°æ®è½¬æ¢ä¿æŒ
3. åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ
4. é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
5. **é‡è¦**ï¼šæµ‹è¯•æ—¶è¦è€ƒè™‘æµè§ˆå™¨ç¼“å­˜çš„å½±å“

## åç»­ç›‘æ§
å»ºè®®æŒç»­ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- é¡µé¢åŠ è½½æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- é”™è¯¯æ—¥å¿—

## æ€§èƒ½åˆ†æå·¥å…·å®‰è£…

### 1. Laravel Debugbar
å·²å®‰è£…å¹¶é…ç½® Laravel Debugbar ç”¨äºå¼€å‘ç¯å¢ƒæ€§èƒ½åˆ†æã€‚

#### å®‰è£…çŠ¶æ€
- âœ… å·²å®‰è£… `barryvdh/laravel-debugbar`
- âœ… å·²å‘å¸ƒé…ç½®æ–‡ä»¶ `config/debugbar.php`
- âœ… å·²å¯ç”¨è°ƒè¯•æ¨¡å¼
- âœ… å·²æ¸…ç†ç¼“å­˜

#### ä½¿ç”¨æ–¹æ³•
1. è®¿é—®ä»»ä½•é¡µé¢ï¼Œåœ¨å³ä¸‹è§’ä¼šçœ‹åˆ° Debugbar å·¥å…·æ 
2. å·¥å…·æ åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š
   - ğŸ” **æŸ¥è¯¢** - æ˜¾ç¤ºæ‰§è¡Œçš„ SQL æŸ¥è¯¢
   - â±ï¸ **æ—¶é—´** - æ˜¾ç¤ºé¡µé¢åŠ è½½æ—¶é—´
   - ğŸ’¾ **å†…å­˜** - æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ
   - ğŸ“ **æ—¥å¿—** - æ˜¾ç¤ºåº”ç”¨æ—¥å¿—
   - ğŸ¯ **è·¯ç”±** - æ˜¾ç¤ºå½“å‰è·¯ç”±ä¿¡æ¯

#### æµ‹è¯•é¡µé¢
è®¿é—® `http://localhost/debug-test` æŸ¥çœ‹ Debugbar æ•ˆæœ

### 2. æ€§èƒ½ç›‘æ§è„šæœ¬
åˆ›å»ºäº† `scripts/performance_monitor.php` ç”¨äºå‘½ä»¤è¡Œæ€§èƒ½åˆ†æã€‚

#### ä½¿ç”¨æ–¹æ³•
```php
require_once 'scripts/performance_monitor.php';

$monitor = new PerformanceMonitor();
// ... ä½ çš„ä»£ç  ...
$monitor->outputReport();
```

### 3. Artisan æ€§èƒ½æµ‹è¯•å‘½ä»¤
åˆ›å»ºäº† `app/Console/Commands/PerformanceTest.php` å‘½ä»¤ã€‚

#### ä½¿ç”¨æ–¹æ³•
```bash
# æµ‹è¯•é»˜è®¤é¡µé¢
php artisan performance:test

# æµ‹è¯•æŒ‡å®šURL
php artisan performance:test http://localhost/dashboard

# æŒ‡å®šæµ‹è¯•æ¬¡æ•°
php artisan performance:test http://localhost/dashboard --iterations=10
```

## æ—¥æœŸ
2025-01-12

## æ›´æ–°è®°å½•
- 2025-01-12ï¼šåˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆä¸»è¦æ§åˆ¶å™¨ä¼˜åŒ–
- 2025-01-12ï¼šå‘ç°å¹¶è§£å†³è§†å›¾ä¸­åˆ†é¡µå¯¹è±¡æ“ä½œé—®é¢˜
- 2025-01-12ï¼šè®°å½•æµè§ˆå™¨ç¼“å­˜é—®é¢˜çš„è°ƒè¯•ç»éªŒ
- 2025-01-12ï¼šå®‰è£…å¹¶é…ç½® Laravel Debugbar æ€§èƒ½åˆ†æå·¥å…·
- 2025-01-12ï¼šåˆ›å»ºæ€§èƒ½ç›‘æ§è„šæœ¬å’Œ Artisan å‘½ä»¤ 